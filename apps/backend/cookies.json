// import express from "express";
// import pool from "../db.js";
// import OpenAI from "openai";
// const router = express.Router();
// const openai = new OpenAI({
//   apiKey: process.env.OPENAI_API_KEY,
// });
// /* ===============================
//    CONSTANTS & KEYWORDS
// ================================ */
// const INTENTS = {
//   GET_PRICE: "GET_PRICE",
//   GET_HISTORY: "GET_HISTORY",
//   GET_TREND: "GET_TREND",
//   PREDICT_TREND: "PREDICT_TREND",
//   COMPARE_PRICES: "COMPARE_PRICES",
//   GET_ALERT: "GET_ALERT",
//   SET_ALERT: "SET_ALERT",
//   HELP: "HELP",
//   OUT_OF_DOMAIN: "OUT_OF_DOMAIN",
// };
// const PRODUCT_KEYWORDS = [
//     { names: [
//             "c√† ph√™",
//             "cafe",
//             "coffee"
//         ], normalized: "c√† ph√™"
//     },
//     { names: [
//             "ti√™u",
//             "h·ªì ti√™u",
//             "pepper"
//         ], normalized: "ti√™u"
//     },
//     { names: [
//             "l√∫a",
//             "g·∫°o",
//             "rice"
//         ], normalized: "l√∫a"
//     },
//     { names: [
//             "cao su",
//             "rubber"
//         ], normalized: "cao su"
//     },
//     { names: [
//             "ca cao",
//             "cacao"
//         ], normalized: "ca cao"
//     },
// ];
// const REGION_KEYWORDS = [
//     "ƒë·∫Øk l·∫Øk",
//     "dak lak",
//     "l√¢m ƒë·ªìng",
//     "lam dong",
//     "gia lai",
//     "ƒë·∫Øk n√¥ng",
//     "dak nong",
//     "ti·ªÅn giang",
//     "tien giang",
//     "s√¥ng c·ª≠u long",
//     "song cuu long",
//     "mekong delta"
// ];
// const PRICE_KEYWORDS = [
//     "gi√°",
//     "bao nhi√™u",
//     "hi·ªán t·∫°i",
//     "price",
//     "cost"
// ];
// const HISTORY_KEYWORDS = [
//     "l·ªãch s·ª≠",
//     "tr∆∞·ªõc ƒë√¢y",
//     "c√°c ng√†y",
//     "bi·∫øn ƒë·ªông",
//     "history"
// ];
// const TREND_KEYWORDS = [
//     "xu h∆∞·ªõng",
//     "ƒëang tƒÉng",
//     "ƒëang gi·∫£m",
//     "trend"
// ];
// const PREDICT_KEYWORDS = [
//     "d·ª± ƒëo√°n",
//     "s·∫Øp t·ªõi",
//     "v√†i ng√†y",
//     "t∆∞∆°ng lai",
//     "predict"
// ];
// const COMPARE_KEYWORDS = [
//     "so s√°nh",
//     "compare",
//     "kh√°c nhau"
// ];
// const ALERT_KEYWORDS = [
//     "c·∫£nh b√°o",
//     "alert",
//     "th√¥ng b√°o",
//     "ƒë·∫∑t gi√°"
// ];
// const HELP_KEYWORDS = [
//     "h∆∞·ªõng d·∫´n",
//     "gi√∫p",
//     "help"
// ];
// function validateAIResult(ai) {
//   if (!ai || typeof ai !== "object") {
//     return { intent: INTENTS.OUT_OF_DOMAIN
//         };
//     }
//     // Validate intent
//   if (!Object.values(INTENTS).includes(ai.intent)) {
//     return { intent: INTENTS.OUT_OF_DOMAIN
//         };
//     }
//     // Validate product
//   if (ai.product) {
//     const validProduct = PRODUCT_KEYWORDS.some(
//       p => p.normalized === ai.product
//     );
//     if (!validProduct) ai.product = null;
//     }
//     // Validate region
//   if (ai.region) {
//     const validRegion = REGION_KEYWORDS.some(
//       r => r.includes(ai.region)
//     );
//     if (!validRegion) ai.region = null;
//     }
//   return ai;
// }
// /* ===============================
//    CONVERSATION CONTEXT (IN-MEMORY)
// ================================ */
// const sessionContext = new Map(); // key: userId
// function updateContext(userId, analysis) {
//   if (!userId) return;
//   const prev = sessionContext.get(userId) || {};
//   sessionContext.set(userId,
//     {
//     product: analysis.product || prev.product,
//     region: analysis.region || prev.region
//     });
// }
// function applyContext(userId, analysis) {
//   if (!userId) return analysis;
//   const ctx = sessionContext.get(userId);
//   if (!ctx) return analysis;
//   return {
//     ...analysis,
//     product: analysis.product || ctx.product,
//     region: analysis.region || ctx.region
//     };
// }
// /* ===============================
//    UTILITY FUNCTIONS
// ================================ */
// function removeVietnameseTones(str) {
//   return str
//     .normalize("NFD")
//     .replace(/[\u0300-\u036f
//     ]/g,
//     "")
//     .replace(/ƒë/g,
//     "d")
//     .replace(/ƒê/g,
//     "D");
// }
// function fuzzyMatch(text, keywords) {
//   const normalized = removeVietnameseTones(text);
//   return keywords.some(k => {
//     const nk = removeVietnameseTones(k);
//     return normalized.includes(nk) || text.includes(k);
//     });
// }
// /* ===============================
//    ENHANCED NLP PARSER
// ================================ */
// function extractProduct(text) {
//   for (const prod of PRODUCT_KEYWORDS) {
//     if (fuzzyMatch(text, prod.names)) {
//       return prod.normalized;
//         }
//     }
//   return null;
// }
// function extractRegion(text) {
//   for (const region of REGION_KEYWORDS) {
//     if (fuzzyMatch(text,
//         [region
//         ])) {
//       return region.split(",")[
//                 0
//             ];
//         }
//     }
//   return null;
// }
// function extractPriceThreshold(text) {
//   const match = text.match(/(\d+)[\s
//     ]?k?/i);
//   if (match) {
//     let price = parseInt(match[
//             1
//         ]);
//     if (text.includes("k") || text.includes("K")) price *= 1000;
//     return price;
//     }
//   return null;
// }
// function parseMessage(message) {
//   const text = message.toLowerCase();
//   const product = extractProduct(text);
//   const region = extractRegion(text);
//   if (ALERT_KEYWORDS.some(k => text.includes(k))) {
//     const threshold = extractPriceThreshold(text);
//     if (text.includes("ƒë·∫∑t") || text.includes("t·∫°o") || text.includes("set")) {
//       return {
//         intent: INTENTS.SET_ALERT,
//         product,
//         region,
//         threshold,
//         condition: text.includes("tr√™n") || text.includes("cao h∆°n") ? "above": "below"
//             };
//         }
//     return { intent: INTENTS.GET_ALERT, product
//         };
//     }
//   if (COMPARE_KEYWORDS.some(k => text.includes(k))) {
//     return { intent: INTENTS.COMPARE_PRICES, product, region
//         };
//     }
//   if (!product && !HELP_KEYWORDS.some(k => text.includes(k))) {
//     return { intent: INTENTS.OUT_OF_DOMAIN
//         };
//     }
//   if (HISTORY_KEYWORDS.some(k => text.includes(k)))
//     return { intent: INTENTS.GET_HISTORY, product, region
//     };
//   if (PREDICT_KEYWORDS.some(k => text.includes(k)))
//     return { intent: INTENTS.PREDICT_TREND, product, region
//     };
//   if (TREND_KEYWORDS.some(k => text.includes(k)))
//     return { intent: INTENTS.GET_TREND, product, region
//     };
//   if (PRICE_KEYWORDS.some(k => text.includes(k)))
//     return { intent: INTENTS.GET_PRICE, product, region
//     };
//   if (HELP_KEYWORDS.some(k => text.includes(k)))
//     return { intent: INTENTS.HELP
//     };
//   if (product) return { intent: INTENTS.GET_PRICE, product, region
//     };
//   return { intent: INTENTS.HELP
//     };
// }
// async function parseMessageWithAI(message) {
//   const completion = await openai.chat.completions.create({
//     model: "gpt-4o-mini",
//     temperature: 0,
//     messages: [
//             {
//         role: "system",
//         content: `
// B·∫°n l√† b·ªô ph√¢n t√≠ch NLP cho chatbot GI√Å N√îNG S·∫¢N VI·ªÜT NAM.
// CH·ªà tr·∫£ v·ªÅ JSON h·ª£p l·ªá.
// KH√îNG markdown.
// KH√îNG gi·∫£i th√≠ch.
// INTENT h·ª£p l·ªá:
// GET_PRICE, GET_HISTORY, GET_TREND, PREDICT_TREND,
// COMPARE_PRICES, SET_ALERT, GET_ALERT, HELP, OUT_OF_DOMAIN
// PRODUCT:
// c√† ph√™, ti√™u, l√∫a, cao su, ca cao
// FORMAT: {
//                     "intent": "...",
//                     "product": string | null,
//                     "region": string | null,
//                     "threshold": number | null,
//                     "condition": "above" | "below" | null
//                 }
// V√≠ d·ª•:
// User: "ƒê·∫∑t c·∫£nh b√°o c√† ph√™ tr√™n 50k ·ªü ƒê·∫Øk L·∫Øk"{
//                     "intent": "SET_ALERT",
//                     "product": "c√† ph√™",
//                     "region": "ƒë·∫Øk l·∫Øk",
//                     "threshold": 50000,
//                     "condition": "above"
//                 }
// `
//             },
//             {
//         role: "user",
//         content: message
//             }
//         ]
//     });
//   return JSON.parse(completion.choices[
//         0
//     ].message.content);
// }
// // async function naturalizeAnswer(rawText) {
// //   const completion = await openai.chat.completions.create({
// //     model: "gpt-4o-mini",
// //     temperature: 0.3,
// //     messages: [
// //       {
// //         role: "system",
// //         content: `
// // B·∫°n l√† chatbot n√¥ng s·∫£n.
// // CH·ªà di·ªÖn ƒë·∫°t l·∫°i cho d·ªÖ hi·ªÉu.
// // KH√îNG th√™m th√¥ng tin m·ªõi.
// // `
// //       },
// //       { role: "user", content: rawText }
// //     ]
// //   });
// //   return completion.choices[0].message.content;
// // }
// /* ===============================
//    ENHANCED ANALYSIS FUNCTIONS
// ================================ */
// function analyzeTrend(prices) {
//   if (prices.length < 2) return { trend: "stable", confidence: "low"
//     };
//   const dataSize = Math.min(prices.length,
//     7);
//   const recent = prices.slice(0, dataSize);
//   const last = recent[
//         0
//     ];
//   const prev = recent[
//         1
//     ];
//   const avg = recent.reduce((sum, p) => sum + p,
//     0) / recent.length;
//   const percentChange = ((last - prev) / prev) * 100;
//   let trend = "stable";
//   let confidence = "medium";
//   if (percentChange > 2) {
//     trend = "up";
//     confidence = percentChange > 5 ? "high": "medium";
//     } else if (percentChange < -2) {
//     trend = "down";
//     confidence = percentChange < -5 ? "high": "medium";
//     }
//   return {
//     trend,
//     confidence,
//     percentChange: percentChange.toFixed(2),
//     average: avg.toFixed(0)
//     };
// }
// function calculateVolatility(prices) {
//   if (prices.length < 2) return 0;
//   const changes = [];
//   for (let i = 1; i < prices.length; i++) {
//     changes.push(Math.abs((prices[i - 1
//         ] - prices[i
//         ]) / prices[i
//         ] * 100));
//     }
//   return changes.reduce((sum, c) => sum + c,
//     0) / changes.length;
// }
// function predictTrend(prices, dataPoints) {
//   if (prices.length < 2) {
//     return {
//       prediction: "‚ö†Ô∏è Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ d·ª± ƒëo√°n (c·∫ßn √≠t nh·∫•t 2 ng√†y)",
//       confidence: "none",
//       reason: "Kh√¥ng ƒë·ªß d·ªØ li·ªáu l·ªãch s·ª≠",
//       dataPoints
//         };
//     }
//     // X√°c ƒë·ªãnh k√≠ch th∆∞·ªõc d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch
//   const hasLongHistory = prices.length >= 14;
//   const hasMediumHistory = prices.length >= 7;
//   const hasShortHistory = prices.length >= 3;
//   let longTermSize, shortTermSize;
//   if (hasLongHistory) {
//         // ƒê·ªß 14+ ng√†y: ph√¢n t√≠ch ƒë·∫ßy ƒë·ªß
//     longTermSize = Math.min(14, prices.length);
//     shortTermSize = 7;
//     } else if (hasMediumHistory) {
//         // 7-13 ng√†y: ph√¢n t√≠ch trung b√¨nh
//     longTermSize = Math.min(10, prices.length);
//     shortTermSize = Math.min(5, prices.length);
//     } else if (hasShortHistory) {
//         // 3-6 ng√†y: ph√¢n t√≠ch c∆° b·∫£n
//     longTermSize = prices.length;
//     shortTermSize = Math.min(3, prices.length);
//     } else {
//         // 2 ng√†y: ch·ªâ so s√°nh ƒë∆°n gi·∫£n
//     const last = prices[
//             0
//         ];
//     const prev = prices[
//             1
//         ];
//     const change = ((last - prev) / prev) * 100;
//     let prediction;
//     if (change > 3) {
//       prediction = "üìà Gi√° v·ª´a TƒÇNG so v·ªõi ng√†y h√¥m qua, c√≥ th·ªÉ ti·∫øp t·ª•c tƒÉng";
//         } else if (change < -3) {
//       prediction = "üìâ Gi√° v·ª´a GI·∫¢M so v·ªõi ng√†y h√¥m qua, c√≥ th·ªÉ ti·∫øp t·ª•c gi·∫£m";
//         } else {
//       prediction = "‚ûñ Gi√° thay ƒë·ªïi nh·∫π, d·ª± ki·∫øn dao ƒë·ªông ·ªïn ƒë·ªãnh";
//         }
//     return {
//       prediction,
//       confidence: "low",
//       percentChange: change.toFixed(2),
//       reason: "D·ªØ li·ªáu √≠t, ch·ªâ d·ª±a tr√™n 2 ng√†y g·∫ßn nh·∫•t",
//       dataPoints
//         };
//     }
//     // T√≠nh to√°n c√°c ch·ªâ s·ªë
//   const longTerm = prices.slice(0, longTermSize);
//   const shortTerm = prices.slice(0, shortTermSize);
//   const longTermAvg = longTerm.reduce((a, b) => a + b,
//     0) / longTerm.length;
//   const shortTermAvg = shortTerm.reduce((a, b) => a + b,
//     0) / shortTerm.length;
//   const currentPrice = prices[
//         0
//     ];
//   const yesterdayPrice = prices[
//         1
//     ];
//   const volatility = calculateVolatility(shortTerm);
//   const momentum = ((shortTermAvg - longTermAvg) / longTermAvg) * 100;
//   const dailyChange = ((currentPrice - yesterdayPrice) / yesterdayPrice) * 100;
//   // Ph√¢n lo·∫°i xu h∆∞·ªõng
//   let trendStrength = "y·∫øu";
//   let trendDirection = "·ªïn ƒë·ªãnh";
//   let trendDescription = "";
//   if (Math.abs(momentum) > 3) {
//     trendStrength = "m·∫°nh";
//     } else if (Math.abs(momentum) > 1) {
//     trendStrength = "trung b√¨nh";
//     }
//   if (momentum > 1) {
//     trendDirection = "tƒÉng";
//     trendDescription = `Xu h∆∞·ªõng TƒÇNG ${trendStrength
//         } (${momentum.toFixed(2)
//         }%)`;
//     } else if (momentum < -1) {
//     trendDirection = "gi·∫£m";
//     trendDescription = `Xu h∆∞·ªõng GI·∫¢M ${trendStrength
//         } (${momentum.toFixed(2)
//         }%)`;
//     } else {
//     trendDescription = `Xu h∆∞·ªõng ·ªîN ƒê·ªäNH (bi·∫øn ƒë·ªông ${Math.abs(momentum).toFixed(2)
//         }%)`;
//     }
//     // Logic d·ª± ƒëo√°n th√¥ng minh
//   let prediction = "";
//   let confidence = "medium";
//   let reason = "";
//   // ƒêi·ªÅu ch·ªânh ƒë·ªô tin c·∫≠y d·ª±a v√†o s·ªë ng√†y d·ªØ li·ªáu
//   if (!hasLongHistory) {
//     confidence = "low";
//     reason = `D·ªØ li·ªáu c√≤n √≠t (${dataPoints
//         } ng√†y), ƒë·ªô ch√≠nh x√°c h·∫°n ch·∫ø. `;
//     } else {
//     reason = `D·ª±a tr√™n ${dataPoints
//         } ng√†y d·ªØ li·ªáu. `;
//     }
//     // Case 1: Xu h∆∞·ªõng tƒÉng m·∫°nh + tƒÉng h√¥m nay
//   if (momentum > 3 && dailyChange > 0) {
//     if (volatility > 8) {
//       prediction = "üöÄ Gi√° C√ì KH·∫¢ NƒÇNG TƒÇNG M·∫†NH trong 1-2 ng√†y t·ªõi";
//       confidence = hasLongHistory ? "high": "medium";
//         } else {
//       prediction = "üìà Gi√° D·ª∞ KI·∫æN TƒÇNG NH·∫∏ trong 1-2 ng√†y t·ªõi";
//         }
//     reason += "Momentum tƒÉng m·∫°nh v√† gi√° ƒëang tƒÉng.";
//     }
//     // Case 2: Xu h∆∞·ªõng gi·∫£m m·∫°nh + gi·∫£m h√¥m nay
//   else if (momentum < -3 && dailyChange < 0) {
//     if (volatility > 8) {
//       prediction = "üìâ Gi√° C√ì KH·∫¢ NƒÇNG GI·∫¢M M·∫†NH trong 1-2 ng√†y t·ªõi";
//       confidence = hasLongHistory ? "high": "medium";
//         } else {
//       prediction = "üìä Gi√° D·ª∞ KI·∫æN GI·∫¢M NH·∫∏ trong 1-2 ng√†y t·ªõi";
//         }
//     reason += "Momentum gi·∫£m m·∫°nh v√† gi√° ƒëang gi·∫£m.";
//     }
//     // Case 3: Gi√° hi·ªán t·∫°i th·∫•p h∆°n trung b√¨nh ng·∫Øn h·∫°n (c√≥ th·ªÉ ph·ª•c h·ªìi)
//   else if (currentPrice < shortTermAvg * 0.98 && momentum > 0) {
//     prediction = "üìà Gi√° C√ì TH·ªÇ PH·ª§C H·ªíI TƒÇNG NH·∫∏ trong 1-2 ng√†y t·ªõi";
//     reason += "Gi√° ƒëang th·∫•p h∆°n trung b√¨nh g·∫ßn ƒë√¢y.";
//     }
//     // Case 4: Gi√° hi·ªán t·∫°i cao h∆°n trung b√¨nh ng·∫Øn h·∫°n (c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh)
//   else if (currentPrice > shortTermAvg * 1.02 && momentum < 0) {
//     prediction = "üìä Gi√° C√ì TH·ªÇ ƒêI·ªÄU CH·ªàNH GI·∫¢M NH·∫∏ trong 1-2 ng√†y t·ªõi";
//     reason += "Gi√° ƒëang cao h∆°n trung b√¨nh g·∫ßn ƒë√¢y.";
//     }
//     // Case 5: ƒê·∫£o chi·ªÅu t·ª´ tƒÉng sang gi·∫£m
//   else if (momentum > 2 && dailyChange < -2) {
//     prediction = "‚ö†Ô∏è Gi√° ƒêANG ƒê·∫¢O CHI·ªÄU t·ª´ tƒÉng sang gi·∫£m, C·∫®N TR·ªåNG";
//     reason += "Xu h∆∞·ªõng tƒÉng nh∆∞ng h√¥m nay gi√° gi·∫£m m·∫°nh.";
//     }
//     // Case 6: ƒê·∫£o chi·ªÅu t·ª´ gi·∫£m sang tƒÉng
//   else if (momentum < -2 && dailyChange > 2) {
//     prediction = "‚úÖ Gi√° ƒêANG PH·ª§C H·ªíI sau ƒë·ª£t gi·∫£m, c√≥ th·ªÉ tƒÉng ti·∫øp";
//     reason += "Xu h∆∞·ªõng gi·∫£m nh∆∞ng h√¥m nay gi√° tƒÉng m·∫°nh.";
//     }
//     // Case 7: Bi·∫øn ƒë·ªông cao - kh√≥ d·ª± ƒëo√°n
//   else if (volatility > 10) {
//     prediction = "üåä Gi√° BI·∫æN ƒê·ªòNG M·∫†NH, kh√≥ d·ª± ƒëo√°n ch√≠nh x√°c. N√™n theo d√µi s√°t";
//     confidence = "low";
//     reason += `Bi·∫øn ƒë·ªông cao (${volatility.toFixed(2)
//         }%).`;
//     }
//     // Case 8: Xu h∆∞·ªõng tƒÉng nh·∫π
//   else if (momentum > 1 && momentum <= 3) {
//     prediction = "üìà Gi√° C√ì XU H∆Ø·ªöNG TƒÇNG NH·∫∏ trong 1-2 ng√†y t·ªõi";
//     reason += "Momentum tƒÉng nh·∫π.";
//     }
//     // Case 9: Xu h∆∞·ªõng gi·∫£m nh·∫π
//   else if (momentum < -1 && momentum >= -3) {
//     prediction = "üìä Gi√° C√ì XU H∆Ø·ªöNG GI·∫¢M NH·∫∏ trong 1-2 ng√†y t·ªõi";
//     reason += "Momentum gi·∫£m nh·∫π.";
//     }
//     // Case 10: ·ªîn ƒë·ªãnh
//   else {
//     prediction = "‚ûñ Gi√° D·ª∞ KI·∫æN DAO ƒê·ªòNG ·ªîN ƒê·ªäNH trong 1-2 ng√†y t·ªõi";
//     reason += "Kh√¥ng c√≥ bi·∫øn ƒë·ªông ƒë√°ng k·ªÉ.";
//     }
//   return {
//     prediction,
//     confidence,
//     volatility: volatility.toFixed(2),
//     momentum: momentum.toFixed(2),
//     dailyChange: dailyChange.toFixed(2),
//     trendDirection,
//     trendStrength,
//     trendDescription,
//     currentPrice: currentPrice.toFixed(0),
//     yesterdayPrice: yesterdayPrice.toFixed(0),
//     shortTermAvg: shortTermAvg.toFixed(0),
//     longTermAvg: longTermAvg.toFixed(0),
//     dataPoints,
//     reason
//     };
// }
// /* ===============================
//    CHATBOT API
// ================================ */
// router.post("/query", async (req, res) => {
//   const { message, userId
//     } = req.body;
//   if (!message) {
//     return res.json({
//       type: "ERROR",
//       text: "Vui l√≤ng nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n."
//         });
//     }
//   let analysis;
//   try {
//     analysis = await parseMessageWithAI(message);
//     console.log("ü§ñ AI Intent:", analysis);
//     } catch (err) {
//     console.warn("‚ö†Ô∏è OpenAI l·ªói ‚Üí fallback rule-based");
//     analysis = parseMessage(message);
//     }
//     // üîê AI Guard Layer ‚Äì B·∫ÆT BU·ªòC
//   analysis = validateAIResult(analysis);
//   console.log("üõ°Ô∏è AI Intent (validated):", analysis);
//   // üß† APPLY CONVERSATION CONTEXT
//   analysis = applyContext(userId, analysis);
//   // üî¥ NEED CLARIFICATION ‚Äì B·∫ÆT M∆† H·ªí
//   if (
//     [INTENTS.GET_PRICE, INTENTS.GET_TREND, INTENTS.PREDICT_TREND, INTENTS.GET_HISTORY
//     ]
//       .includes(analysis.intent)
//     && !analysis.product
//   ) {
//     return res.json({
//       type: "CLARIFY",
//       text: "B·∫°n mu·ªën h·ªèi gi√° s·∫£n ph·∫©m n√†o? (c√† ph√™, ti√™u, ...)"
//         });
//     }
//     // üî¥ NEED CLARIFICATION ‚Äì thi·∫øu khu v·ª±c (region)
//   if (
//     analysis.intent === INTENTS.GET_PRICE &&
//     analysis.product &&
//     !analysis.region
//   ) {
//     return res.json({
//       type: "CLARIFY",
//       text: `B·∫°n mu·ªën xem gi√° ${analysis.product
//             } ·ªü khu v·ª±c n√†o? (ƒê·∫Øk L·∫Øk, Gia Lai, L√¢m ƒê·ªìng...)`
//         });
//     }
//     // üß† UPDATE CONVERSATION CONTEXT
//   updateContext(userId, analysis);
//   try {
//         /* ===============================
//        GET CURRENT PRICE
//     ================================ */
//     if (analysis.intent === INTENTS.GET_PRICE) {
//       let query = `
//         SELECT name, region, currentPrice, unit, trend, lastUpdate
//         FROM products
//         WHERE name LIKE ?
//       `;
//       let params = [`%${analysis.product
//                 }%`
//             ];
//       if (analysis.region) {
//         query += " AND region LIKE ?";
//         params.push(`%${analysis.region
//                 }%`);
//             }
//       query += " ORDER BY lastUpdate DESC LIMIT 3";
//       const [rows
//             ] = await pool.query(query, params);
//       if (rows.length === 0) {
//         return res.json({
//           type: "INFO",
//           text: `Kh√¥ng t√¨m th·∫•y gi√° ${analysis.product
//                     }${analysis.region ? ` t·∫°i ${analysis.region
//                         }` : ''
//                     }. Th·ª≠ t√¨m ki·∫øm s·∫£n ph·∫©m kh√°c? üîç`,
//                 });
//             }
//       return res.json({
//         type: "PRICE_INFO",
//         data: rows.length === 1 ? rows[
//                     0
//                 ] : rows,
//         message: rows.length > 1 ? `T√¨m th·∫•y ${rows.length
//                 } k·∫øt qu·∫£:` : null
//             });
//         }
//         /* ===============================
//        GET PRICE HISTORY
//     ================================ */
//     if (analysis.intent === INTENTS.GET_HISTORY) {
//       const [
//                 [product
//                 ]
//             ] = await pool.query(
//         `
//     SELECT p.id, p.name, p.region
//     FROM products p
//     JOIN categories c ON p.category_id = c.id
//     WHERE LOWER(c.name) LIKE ?
//       ${analysis.region ? "AND LOWER(p.region) LIKE ?": ""
//             }
//     ORDER BY p.lastUpdate DESC
//     LIMIT 1
//     `,
//         analysis.region
//           ? [`%${analysis.product
//                 }%`, `%${analysis.region
//                 }%`
//             ]
//           : [`%${analysis.product
//                 }%`
//             ]
//       );
//       if (!product) {
//         return res.json({
//           type: "INFO",
//           text: `Kh√¥ng t√¨m th·∫•y ${analysis.product
//                     }${analysis.region ? " t·∫°i " + analysis.region : ""
//                     }.`
//                 });
//             }
//       const [history
//             ] = await pool.query(
//         `
//     SELECT price, updated_at
//     FROM price_history
//     WHERE product_id = ?
//     ORDER BY updated_at DESC
//     `,
//             [product.id
//             ]
//       );
//       if (history.length === 0) {
//         return res.json({
//           type: "INFO",
//           text: `Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠ gi√° cho ${product.name
//                     }.`
//                 });
//             }
//       return res.json({
//         type: "HISTORY",
//         data: {
//           product: product.name,
//           region: product.region,
//           records: history.reverse(),
//           days: history.length
//                 }
//             });
//         }
//         /* ===============================
//        GET CURRENT TREND
//     ================================ */
//     if (analysis.intent === INTENTS.GET_TREND) {
//       let query = "SELECT id, name, region, trend FROM products WHERE name LIKE ?";
//       let params = [`%${analysis.product
//                 }%`
//             ];
//       if (analysis.region) {
//         query += " AND region LIKE ?";
//         params.push(`%${analysis.region
//                 }%`);
//             }
//       query += " LIMIT 1";
//       const [
//                 [product
//                 ]
//             ] = await pool.query(query, params);
//       if (!product) {
//         return res.json({
//           type: "INFO",
//           text: `Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ${analysis.product
//                     }${analysis.region ? ` t·∫°i ${analysis.region
//                         }` : ''
//                     }.`
//                 });
//             }
//       const [history
//             ] = await pool.query(
//         `SELECT price FROM price_history 
//          WHERE product_id = ? 
//          ORDER BY updated_at DESC 
//          LIMIT 10`,
//             [product.id
//             ]
//       );
//       if (history.length === 0) {
//         return res.json({
//           type: "INFO",
//           text: `Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch xu h∆∞·ªõng cho ${product.name
//                     }.`
//                 });
//             }
//       const prices = history.map(h => Number(h.price));
//       const trendAnalysis = analyzeTrend(prices);
//       const trendMap = {
//         up: "ƒëang tƒÉng üìà",
//         down: "ƒëang gi·∫£m üìâ",
//         stable: "ƒëang ·ªïn ƒë·ªãnh ‚ûñ",
//             };
//       const finalText = `Xu h∆∞·ªõng gi√° ${product.name
//             } hi·ªán t·∫°i ${trendMap[trendAnalysis.trend
//                 ]
//             }`;
//       return res.json({
//         type: "TREND",
//         text: finalText,
//         data: {
//           product: product.name,
//           region: product.region,
//           trend: trendAnalysis.trend,
//           percentChange: trendAnalysis.percentChange,
//           confidence: trendAnalysis.confidence,
//           average: trendAnalysis.average,
//           dataPoints: history.length
//                 }
//             });
//         }
//         /* ===============================
//        PREDICT SHORT-TERM TREND
//     ================================ */
//     if (analysis.intent === INTENTS.PREDICT_TREND) {
//       let query = "SELECT id, name, region FROM products WHERE name LIKE ?";
//       let params = [`%${analysis.product
//                 }%`
//             ];
//       if (analysis.region) {
//         query += " AND region LIKE ?";
//         params.push(`%${analysis.region
//                 }%`);
//             }
//       query += " LIMIT 1";
//       const [
//                 [product
//                 ]
//             ] = await pool.query(query, params);
//       if (!product) {
//         return res.json({
//           type: "INFO",
//           text: `Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ${analysis.product
//                     }${analysis.region ? ` t·∫°i ${analysis.region
//                         }` : ''
//                     }.`,
//                 });
//             }
//             // L·∫•y T·∫§T C·∫¢ l·ªãch s·ª≠ gi√° c√≥ s·∫µn
//       const [history
//             ] = await pool.query(
//         `SELECT price, updated_at FROM price_history 
//          WHERE product_id = ? 
//          ORDER BY updated_at DESC`,
//             [product.id
//             ]
//       );
//       console.log(`üìä S·∫£n ph·∫©m: ${product.name
//             }, S·ªë ng√†y d·ªØ li·ªáu: ${history.length
//             }`);
//       if (history.length < 2) {
//         return res.json({
//           type: "INFO",
//           text: `Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ d·ª± ƒëo√°n xu h∆∞·ªõng cho ${product.name
//                     }. C·∫ßn √≠t nh·∫•t 2 ng√†y d·ªØ li·ªáu (hi·ªán c√≥ ${history.length
//                     } ng√†y).`,
//                 });
//             }
//       const prices = history.map(h => Number(h.price));
//       const prediction = predictTrend(prices, history.length);
//       // ƒê·ªãnh d·∫°ng th√¥ng b√°o d·ª±a tr√™n s·ªë l∆∞·ª£ng d·ªØ li·ªáu
//       let confidenceText = "";
//       if (prediction.confidence === "high") {
//         confidenceText = "‚úÖ ƒê·ªô tin c·∫≠y: CAO";
//             } else if (prediction.confidence === "medium") {
//         confidenceText = "‚ö†Ô∏è ƒê·ªô tin c·∫≠y: TRUNG B√åNH";
//             } else if (prediction.confidence === "low") {
//         confidenceText = "‚ùó ƒê·ªô tin c·∫≠y: TH·∫§P";
//             } else {
//         confidenceText = "‚ùå Kh√¥ng ƒë·ªß d·ªØ li·ªáu";
//             }
//       let responseText = `**D·ª± ƒëo√°n gi√° ${product.name
//             }**`;
//       if (product.region) {
//         responseText += ` **(${product.region
//                 })**`;
//             }
//       responseText += `\n\n${prediction.prediction
//             }\n\n${confidenceText
//             }`;
//       // Th√™m th√¥ng tin chi ti·∫øt n·∫øu c√≥ ƒë·ªß d·ªØ li·ªáu
//       if (history.length >= 3) {
//         responseText += `\nüìä Bi·∫øn ƒë·ªông: ${prediction.volatility
//                 }%`;
//         responseText += `\nüìà Momentum: ${prediction.momentum
//                 }%`;
//         responseText += `\nüí∞ Gi√° h√¥m nay: ${Number(prediction.currentPrice).toLocaleString()
//                 } VNƒê`;
//         responseText += `\nüìÖ D·ªØ li·ªáu: ${prediction.dataPoints
//                 } ng√†y`;
//             }
//       responseText += `\n\nüí° ${prediction.reason
//             }`;
//       return res.json({
//         type: "PREDICTION",
//         text: responseText,
//         data: {
//           ...prediction,
//           product: product.name,
//           region: product.region
//                 }
//             });
//         }
//         /* ===============================
//        COMPARE PRICES
//     ================================ */
//     if (analysis.intent === INTENTS.COMPARE_PRICES) {
//       const [rows
//             ] = await pool.query(
//         `SELECT name, region, currentPrice, unit, trend
//          FROM products
//          WHERE name LIKE ?
//          ORDER BY currentPrice DESC`,
//             [`%${analysis.product
//                 }%`
//             ]
//       );
//       if (rows.length < 2) {
//         return res.json({
//           type: "INFO",
//           text: "Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ so s√°nh gi√° gi·ªØa c√°c v√πng.",
//                 });
//             }
//       return res.json({
//         type: "COMPARE",
//         data: {
//           product: analysis.product,
//           regions: rows
//                 }
//             });
//         }
//         /* ===============================
//        SET PRICE ALERT
//     ================================ */
//     if (analysis.intent === INTENTS.SET_ALERT) {
//       if (!userId) {
//         return res.json({
//           type: "INFO",
//           text: "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng c·∫£nh b√°o gi√°.",
//                 });
//             }
//       if (!analysis.product) {
//         return res.json({
//           type: "INFO",
//           text: "Vui l√≤ng cho bi·∫øt s·∫£n ph·∫©m c·∫ßn c·∫£nh b√°o. V√≠ d·ª•: 'ƒê·∫∑t c·∫£nh b√°o c√† ph√™ tr√™n 50000'",
//                 });
//             }
//       if (!analysis.threshold) {
//         return res.json({
//           type: "INFO",
//           text: "Vui l√≤ng cho bi·∫øt m·ª©c gi√° c·∫ßn c·∫£nh b√°o. V√≠ d·ª•: 'ƒê·∫∑t c·∫£nh b√°o c√† ph√™ tr√™n 50000'",
//                 });
//             }
//             // T√¨m product_id
//       const [
//                 [product
//                 ]
//             ] = await pool.query(
//         "SELECT id FROM products WHERE name LIKE ? LIMIT 1",
//             [`%${analysis.product
//                 }%`
//             ]
//       );
//       if (!product) {
//         return res.json({
//           type: "INFO",
//           text: `Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ${analysis.product
//                     }.`,
//                 });
//             }
//             // L·∫•y email ng∆∞·ªùi d√πng
//       const [
//                 [user
//                 ]
//             ] = await pool.query(
//         "SELECT email FROM users WHERE id = ?",
//             [userId
//             ]
//       );
//       await pool.query(
//         `INSERT INTO price_alerts (user_id, product_id, target_price, alert_condition, email, notified)
//          VALUES (?, ?, ?, ?, ?, false)`,
//             [userId, product.id, analysis.threshold, analysis.condition, user.email
//             ]
//       );
//       return res.json({
//         type: "SUCCESS",
//         text: `‚úÖ ƒê√£ ƒë·∫∑t c·∫£nh b√°o gi√° ${analysis.product
//                 } ${analysis.condition === 'above' ? 'tr√™n' : 'd∆∞·ªõi'
//                 } ${analysis.threshold.toLocaleString()
//                 } VNƒê`,
//             });
//         }
//         /* ===============================
//        GET USER ALERTS
//     ================================ */
//     if (analysis.intent === INTENTS.GET_ALERT) {
//       if (!userId) {
//         return res.json({
//           type: "INFO",
//           text: "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch c·∫£nh b√°o.",
//                 });
//             }
//       const [alerts
//             ] = await pool.query(
//         `SELECT pa.*, p.name as product_name 
//          FROM price_alerts pa
//          JOIN products p ON pa.product_id = p.id
//          WHERE pa.user_id = ? AND pa.notified = false
//          ORDER BY pa.created_at DESC`,
//             [userId
//             ]
//       );
//       if (alerts.length === 0) {
//         return res.json({
//           type: "INFO",
//           text: "B·∫°n ch∆∞a ƒë·∫∑t c·∫£nh b√°o gi√° n√†o. Th·ª≠ h·ªèi 'ƒê·∫∑t c·∫£nh b√°o c√† ph√™ tr√™n 50k' ƒë·ªÉ b·∫Øt ƒë·∫ßu.",
//                 });
//             }
//       let text = "üîî **Danh s√°ch c·∫£nh b√°o gi√° c·ªßa b·∫°n:**\n\n";
//       alerts.forEach((a, index) => {
//         text += `${index + 1
//                 }. ${a.product_name
//                 } ${a.alert_condition === "above" ? "tr√™n": "d∆∞·ªõi"
//                 } ${Number(a.target_price).toLocaleString()
//                 } VNƒê\n`;
//             });
//       return res.json({
//         type: "ALERT_LIST",
//         text,
//         data: alerts
//             });
//         }
//     if (analysis.intent === INTENTS.HELP) {
//       sessionContext.delete(userId);
//       return res.json({
//         type: "HELP",
//         text: `
// ü§ñ **T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:**
// ‚Ä¢ H·ªèi gi√° hi·ªán t·∫°i  
// üëâ "Gi√° c√† ph√™ ƒê·∫Øk L·∫Øk h√¥m nay"
// ‚Ä¢ Xem l·ªãch s·ª≠ gi√°  
// üëâ "L·ªãch s·ª≠ gi√° ti√™u Gia Lai"
// ‚Ä¢ Xem xu h∆∞·ªõng  
// üëâ "Xu h∆∞·ªõng gi√° c√† ph√™"
// ‚Ä¢ D·ª± ƒëo√°n ng·∫Øn h·∫°n  
// üëâ "D·ª± ƒëo√°n gi√° c√† ph√™ v√†i ng√†y t·ªõi"
// ‚Ä¢ So s√°nh gi√°  
// üëâ "So s√°nh gi√° ti√™u c√°c v√πng"
// ‚Ä¢ ƒê·∫∑t c·∫£nh b√°o  
// üëâ "ƒê·∫∑t c·∫£nh b√°o c√† ph√™ tr√™n 50k"
// ‚Ä¢ Xem c·∫£nh b√°o  
// üëâ "C·∫£nh b√°o gi√° c·ªßa t√¥i"
// `
//             });
//         }
//     if (analysis.intent === INTENTS.OUT_OF_DOMAIN) {
//       sessionContext.delete(userId);
//       return res.json({
//         type: "OUT_OF_DOMAIN",
//         text: "‚ùì T√¥i hi·ªán ch·ªâ h·ªó tr·ª£ th√¥ng tin **gi√° n√¥ng s·∫£n** (c√† ph√™, ti√™u, l√∫a, cao su...). B·∫°n th·ª≠ h·ªèi l·∫°i nh√©!"
//             });
//         }
//     return res.json({
//       type: "INFO",
//       text: "ü§î T√¥i ch∆∞a hi·ªÉu r√µ c√¢u h·ªèi. B·∫°n c√≥ th·ªÉ h·ªèi l·∫°i theo c√°ch kh√°c kh√¥ng?"
//         });
//     } catch (error) {
//     console.error("‚ùå Chatbot error:", error);
//     return res.status(500).json({
//       type: "ERROR",
//       text: "ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i sau."
//         });
//     }
// });
// /* ===============================
//    EXPORT ROUTER
// ================================ */
// export default router;